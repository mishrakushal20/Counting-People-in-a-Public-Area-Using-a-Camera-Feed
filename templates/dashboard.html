<!DOCTYPE html>
<html>
<head>
    <title>Smart Crowd Monitoring Dashboard</title>

    <!-- SIDEBAR CSS -->
     <link rel="stylesheet" href="/static/css/theme.css">
     <link rel="stylesheet" href="/static/css/sidebar.css">

<style>

body{
    font-family: Arial;
    margin:0;
    background: var(--bg-main);
    color: var(--text-main);
    transition: background .3s ease, color .3s ease;
}

/* ================= MAIN CONTENT ================= */

.main-content{
    margin-left:250px;
    padding:18px;
}

/* ================= VIDEO BOX ================= */

.video-wrapper{
    display:flex;
    justify-content:flex-start;
    align-items:flex-start;

    /* ðŸ”¥ IMPORTANT: sidebar ke baad hi start */
    margin-left:0;
}

.video-box{
    width:900px;
    height:500px;

    border-radius:18px;
    overflow:hidden;
    position:relative;

    background: var(--bg-card);
    border:1px solid var(--border-soft);
    box-shadow: var(--shadow-soft);

    /* ðŸ”¥ ALIGNMENT FIX */
    margin-left:0;
    margin-right:auto;
    margin-bottom:18px;
}

.video-feed{
    width:100%;
    height:100%;
    object-fit:cover;
}

/* LIVE badge */
.live-tag{
    position:absolute;
    top:12px;
    left:12px;

    padding:6px 14px;
    border-radius:999px;

    background: var(--danger);
    color:white;
    font-weight:700;
    font-size:13px;
}


/* ================= UI ================= */

.topbar{
    font-size:22px;
    font-weight:bold;
    margin-bottom:12px;
}

.glass{
    background: var(--bg-card);
    border:1px solid var(--border-soft);
    box-shadow: var(--shadow-soft);
}

.card{
    padding:20px;
    border-radius:15px;
    min-width:240px;
    color:white;
}

/* STATUS COLORS (INTENTIONAL â€“ OK) */
.green{ background:#16a34a; }
.yellow{ background:#ca8a04; }
.red{ background:#dc2626; }

.overlay-box{
    display:flex;
    gap:15px;
    flex-wrap:wrap;
}

.live-alert{
    padding:10px 15px;
    border-radius:10px;
    background: var(--danger);
    color:white;
    font-weight:bold;
    display:none;
    width:max-content;
    animation:pulse 1.1s infinite;
}

@keyframes pulse{
    0%{transform:scale(1);}
    50%{transform:scale(1.05);}
    100%{transform:scale(1);}
}

/* ================= UPLOAD ================= */

.upload-panel{
    padding:18px;
    margin-bottom:18px;
    border-radius:15px;

    max-width:900px;
    margin-left:0;        /* sidebar se chipka */
    margin-right:auto;   /* right side flexible */

    background: var(--bg-card);
    border:1px solid var(--border-soft);
    box-shadow: var(--shadow-soft);
}


.upload-title{
    font-size:16px;
    font-weight:bold;
    margin-bottom:10px;
}

.upload-box{
    display:block;
    padding:15px;
    border:2px dashed var(--border-soft);
    border-radius:12px;
    cursor:pointer;
    margin-bottom:12px;
    transition:.3s;
}

.upload-box:hover{
    background: var(--accent-soft);
}

.upload-btn{
    padding:10px 18px;
    border:none;
    border-radius:10px;
    font-weight:bold;
    cursor:pointer;
    background: var(--accent);
    color:white;
}

</style>
</head>

<body id="themeBody">

<!-- âœ… SIDEBAR (COMMON) -->
{% include "sidebar.html" %}

<!-- âœ… MAIN CONTENT -->
<div class="main-content">

    <div class="topbar">Smart AI Crowd Dashboard</div>

    <!-- UPLOAD PANEL -->
    <div class="glass upload-panel">
        <form action="/upload" method="POST" enctype="multipart/form-data" onsubmit="onUploadStart()">
            <div class="upload-title">ðŸ“¤ Upload CCTV / Recorded Video</div>

            <label class="upload-box">
                <input type="file" name="video" accept="video/*" required hidden>
                <span id="fileName">Click to choose video</span>
            </label>

            <button class="upload-btn" type="submit">â–¶ Start Crowd Counting</button>
        </form>
    </div>

    <div id="floatingAlert" class="live-alert">
        âš  High Crowd Detected
    </div>

    <!-- VIDEO -->
    <div class="video-wrapper">
        <div class="video-box">
            <div class="live-tag">LIVE</div>
            <img id="bgVideo"
                 src="/processed-video?init=1"
                 class="video-feed"
                 onerror="reloadStream()">
        </div>
    </div>

    <!-- COUNTERS -->
    <div class="overlay-box">
        <div class="card glass green">
            Entered: <span id="entered">0</span>
        </div>

        <div class="card glass yellow">
            Exited: <span id="exited">0</span>
        </div>

        <div class="card glass red">
            Inside: <span id="inside">0</span>
        </div>
    </div>

</div>

<script>

function toggleTheme(){
    document.getElementById("themeBody").classList.toggle("light");
    document.getElementById("themeBody").classList.toggle("dark");
}

function reloadStream(){
    document.getElementById("bgVideo").src =
        "/processed-video?x=" + Date.now();
}

document.querySelector('input[name="video"]').addEventListener("change", e=>{
    document.getElementById("fileName").innerText =
        e.target.files[0]?.name || "Click to choose video";
})

function onUploadStart(){
    document.getElementById("entered").innerText = 0;
    document.getElementById("exited").innerText = 0;
    document.getElementById("inside").innerText = 0;
    setTimeout(reloadStream, 2000);
}

async function fetchLive(){
    const res = await fetch("/live-data");
    const data = await res.json();

    document.getElementById("entered").innerText = data.entered;
    document.getElementById("exited").innerText = data.exited;
    document.getElementById("inside").innerText = data.inside;

    let alertTag = document.getElementById("floatingAlert");
    let video = document.getElementById("bgVideo");

    if(data.inside < 20){
        video.style.filter = "brightness(1)";
        alertTag.style.display = "none";
    }
    else if(data.inside < 50){
        video.style.filter = "brightness(1.1) saturate(1.3)";
        alertTag.style.display = "none";
    }
    else{
        video.style.filter = "brightness(0.8) saturate(1.8)";
        alertTag.style.display = "block";
    }
}

setInterval(fetchLive, 800);

</script>
<script src="/static/js/route-guard.js"></script>
<script>
    console.log("Dashboard route guard running");
    requireAuth();
</script>


</body>
</html>
